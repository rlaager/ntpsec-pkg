#!/usr/bin/make -f

DEB_HOST_ARCH_OS ?= $(shell dpkg-architecture -qDEB_HOST_ARCH_OS)

export DEB_BUILD_MAINT_OPTIONS = hardening=+bindnow,+pie
export DEB_CFLAGS_MAINT_APPEND = -fno-strict-aliasing
export DEB_LDFLAGS_MAINT_APPEND = -Wl,--as-needed
include /usr/share/dpkg/buildflags.mk

%:
	dh $@ --with python3

override_dh_auto_configure:
ifeq (hurd, $(DEB_HOST_ARCH_OS))
	# hurd does not provided the system calls needed for ntpd to work.
	exit 1
endif
	# Use the packaged version of autorevision:
	ln -sf /usr/bin/autorevision wafhelpers/autorevision.sh

	# Only build with refclocks NOT slated for removal.  See also
	# debian/patches/update-refclock-docs.patch.
	#
	# Upstream references:
	# https://www.ntpsec.org/removal-plan.html
	# https://www.ntpsec.org/drivers.html
	#
	# Also drop modem.  It "requires a Hayes-compatible 1200bps modem,
	# hardware now 20 years obsolete".
	CFLAGS='$(CFLAGS) $(CPPFLAGS)' \
	LDFLAGS='$(LDFLAGS)' \
		python3 waf configure \
		--prefix=/usr \
		--enable-debug-gdb --enable-mssntp \
		--refclock=local,spectracom,generic,arbiter,nmea,pps,hpgps,shm,trimble,oncore,jjy,zyfer,neoclock,gpsd \
		--enable-doc --htmldir=/usr/share/doc/ntpsec/html \
		--build-epoch=$(shell date -d "$(shell dpkg-parsechangelog --show-field=Date)" "+%s")

override_dh_auto_build:
	python3 waf build -v

override_dh_auto_clean:
	python3 waf clean || true
	rm -rf \
		build \
		.lock-waf_*_build \
		ntpclients/ntp \
		pylib/control.py \
		pylib/magic.py \
		pylib/version.py \
		.waf* \
		wafhelpers/autorevision.sh \
		wafhelpers/.autorevision-cache
	find -name "*.pyc" -delete

override_dh_install:
	python3 waf install --destdir=$(CURDIR)/debian/tmp
	rm -rf debian/tmp/usr/lib/python3/dist-packages/ntp/__pycache__
	mv \
		debian/tmp/usr/bin/ntptime \
		debian/tmp/usr/bin/ntpkeygen \
		debian/tmp/usr/bin/ntploggps \
		debian/tmp/usr/bin/ntplogtemp \
		debian/tmp/usr/sbin/
	install -m 755 \
		ntpclients/ntpmon \
		ntpclients/ntptrace \
		debian/tmp/usr/bin
	install -m 755 \
		attic/ntpdate \
		ntpclients/ntpleapfetch \
		ntpclients/ntpwait \
		debian/tmp/usr/sbin

	install -d debian/ntpsec/lib/systemd/system
	install -m 644 \
		etc/ntpd.service \
		debian/ntpsec/lib/systemd/system/ntp.service
	install -m 644 \
		etc/ntp-wait.service \
		debian/ntpsec/lib/systemd/system/
	install -m 644 \
		debian/ntpsec.ntp-rotate-stats.service \
		debian/ntpsec/lib/systemd/system/ntp-rotate-stats.service
	install -m 644 \
		debian/ntpsec.ntp-rotate-stats.timer \
		debian/ntpsec/lib/systemd/system/ntp-rotate-stats.timer

	install -d debian/ntpsec-ntpviz/lib/systemd/system
	install -m 644 \
		etc/ntploggps.service \
		etc/ntploggps.timer \
		etc/ntplogtemp.service \
		etc/ntplogtemp.timer \
		etc/ntpviz-daily.service \
		etc/ntpviz-daily.timer \
		etc/ntpviz-weekly.service \
		etc/ntpviz-weekly.timer \
		debian/ntpsec-ntpviz/lib/systemd/system/

	install -d debian/ntpsec-ntpviz/etc/ntpviz
	install -m 644 \
		www/day/footer debian/ntpsec-ntpviz/etc/ntpviz/footer.html
	install -m 644 \
		www/day/header debian/ntpsec-ntpviz/etc/ntpviz/header.html
	install -m 644 \
		debian/ntpviz.options debian/ntpsec-ntpviz/etc/ntpviz/options
	install -m 644 \
		www/index.html debian/ntpsec-ntpviz/etc/ntpviz/index.html

	install -d debian/ntpsec-ntpviz/usr/share/ntpsec-ntpviz/ntpviz
	install -m 644 \
		www/favicon.ico \
		www/ntpsec-logo.png \
		debian/ntpsec-ntpviz/usr/share/ntpsec-ntpviz/ntpviz

	install -D -m 0644 debian/ntp.dhcp \
		debian/ntpsec/etc/dhcp/dhclient-exit-hooks.d/ntp
	install -D -m 0755 debian/ntp.networkmanager \
		debian/ntpsec/etc/NetworkManager/dispatcher.d/ntp
	install -D -m 0644 debian/ntpdate.dhcp \
		debian/ntpsec-ntpdate/etc/dhcp/dhclient-exit-hooks.d/ntpdate
	install -D -m 0755 debian/ntpdate-debian \
		debian/ntpsec-ntpdate/usr/sbin/ntpdate-debian

ifeq (yes,$(shell dpkg-vendor --derives-from Ubuntu && echo yes))
	install -D -m 0644 debian/ntp.conf.ubuntu debian/ntpsec/etc/ntp.conf
else
	install -D -m 0644 debian/ntp.conf debian/ntpsec/etc/ntp.conf
endif
	install -D -m 0644 debian/ntpviz.conf \
		debian/ntpsec-ntpviz/etc/ntp.d/ntpviz.conf

	# install apparmor profile
	install -D -m 0644 debian/apparmor-profile \
		debian/ntpsec/etc/apparmor.d/usr.sbin.ntpd
	install -D -m 0644 debian/apparmor-profile.tunable \
		debian/ntpsec/etc/apparmor.d/tunables/ntpd
	dh_link -pntpsec etc/apparmor.d/usr.sbin.ntpd \
		etc/apparmor/init/network-interface-security/usr.sbin.ntpd

	# install apport hook
	install -D -m 644 debian/source_ntpsec.py \
		debian/ntpsec/usr/share/apport/package-hooks/source_ntpsec.py

	dh_link
	dh_install

override_dh_installinit:
	dh_installinit -pntpsec --name=ntp --error-handler=installinit_error
	dh_installinit -pntpsec-ntpviz --name=ntpviz
	dh_installinit -pntpsec-ntpdate
	mv debian/ntpsec-ntpdate/etc/default/ntpsec-ntpdate \
		debian/ntpsec-ntpdate/etc/default/ntpdate
ifeq (yes,$(shell dpkg-vendor --derives-from Ubuntu && echo yes))
	install -m 644 debian/ntpsec-ntpdate.default.ubuntu \
		debian/ntpsec-ntpdate/etc/default/ntpdate
endif
	dh_apparmor --profile-name=usr.sbin.ntpd -pntpsec

override_dh_systemd_start:
	dh_systemd_start -pntpsec ntp.service ntp-rotate-stats.timer
	dh_systemd_start -pntpsec-ntpviz \
		ntploggps.timer \
		ntplogtemp.timer \
		ntpviz-daily.timer \
		ntpviz-weekly.timer

override_dh_installlogcheck:
	dh_installlogcheck -a
	mv debian/ntpsec-ntpdate/etc/logcheck/ignore.d.server/ntpsec-ntpdate \
		debian/ntpsec-ntpdate/etc/logcheck/ignore.d.server/ntpdate

override_dh_installifupdown:
	dh_installifupdown -a
	mv debian/ntpsec-ntpdate/etc/network/if-up.d/ntpsec-ntpdate \
		debian/ntpsec-ntpdate/etc/network/if-up.d/ntpdate

PKD  = $(abspath $(dir $(word 1,$(MAKEFILE_LIST))))
PKG  = $(word 2,$(shell dpkg-parsechangelog -l$(PKD)/changelog --show-field=Source))
VER ?= $(shell dpkg-parsechangelog -l$(PKD)/changelog | perl -ne 'print $$1 if m{^Version:\s+(?:\d+:)?(\d.*)(?:\-\d+.*)};')

.PHONY: get-orig-source
## http://wiki.debian.org/onlyjob/get-orig-source
get-orig-source:  $(info I: $(PKG)_$(VER))
	@echo "# Downloading..."
	uscan --noconf --verbose --rename --destdir=$(CURDIR) \
		--check-dirname-level=0 --force-download \
		--download-version $(VER) $(PKD)

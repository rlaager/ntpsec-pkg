From e243d32b5c2b5e7ddb5ba030721fe8168cc72f49 Mon Sep 17 00:00:00 2001
From: "Eric S. Raymond" <esr@thyrsus.com>
Date: Fri, 9 Dec 2016 17:38:48 -0500
Subject: [PATCH 251/268] Cleanup after broadcast/multicast removal.

---
 include/ntp.h      |  7 ++++---
 include/ntpd.h     |  2 --
 ntpd/ntp_config.c  | 26 --------------------------
 ntpd/ntp_control.c |  7 +++----
 ntpd/ntp_parser.y  |  3 +--
 ntpd/ntp_proto.c   | 13 +------------
 ntpd/ntpd.c        |  1 -
 7 files changed, 9 insertions(+), 50 deletions(-)

diff --git a/include/ntp.h b/include/ntp.h
index 7464d4c..c86de8f 100644
--- a/include/ntp.h
+++ b/include/ntp.h
@@ -615,11 +615,11 @@ struct pkt {
  */
 #define	PROTO_BROADCLIENT	1	/* (not used) */
 #define	PROTO_PRECISION		2	/* (not used) */
-#define	PROTO_AUTHENTICATE	3
+#define	PROTO_AUTHENTICATE	3	/* (not used) */
 #define	PROTO_BROADDELAY	4	/* (not used) */
 #define	PROTO_AUTHDELAY		5
-#define PROTO_MULTICAST_ADD	6
-#define PROTO_MULTICAST_DEL	7
+#define PROTO_MULTICAST_ADD	6	/* (not used) */
+#define PROTO_MULTICAST_DEL	7	/* (not used) */
 #define PROTO_NTP		8
 #define PROTO_KERNEL		9
 #define PROTO_MONITOR		10
@@ -672,6 +672,7 @@ struct pkt {
 
 /*
  * Default parameters.  We use these in the absence of something better.
+ * (Historical relic - muliticast mode has been removed for security reasons.)
  */
 #define INADDR_NTP	0xe0000101	/* NTP multicast address 224.0.1.1 */
 
diff --git a/include/ntpd.h b/include/ntpd.h
index a407b97..9c10ae2 100644
--- a/include/ntpd.h
+++ b/include/ntpd.h
@@ -186,7 +186,6 @@ extern	void	init_proto	(const bool);
 extern	void	set_sys_tick_precision(double);
 extern	void	proto_config	(int, u_long, double);
 extern	void	proto_clr_stats (void);
-extern  void    proto_dump(FILE *);
 
 /* ntp_refclock.c */
 #ifdef	REFCLOCK
@@ -398,7 +397,6 @@ extern int	sys_minclock;		/* minimum candidates */
 /*
  * Nonspecified system state variables.
  */
-extern bool	sys_authenticate;	/* requre authentication for config */
 extern l_fp	sys_authdelay;		/* authentication delay */
 extern u_long 	sys_epoch;		/* last clock update time */
 extern keyid_t	sys_private;		/* private value for session seed */
diff --git a/ntpd/ntp_config.c b/ntpd/ntp_config.c
index 7b54bfe..13c719d 100644
--- a/ntpd/ntp_config.c
+++ b/ntpd/ntp_config.c
@@ -225,13 +225,6 @@ static void free_config_ttl(config_tree *);
 static void free_config_unpeers(config_tree *);
 static void free_config_vars(config_tree *);
 
-static void destroy_address_fifo(address_fifo *);
-#define FREE_ADDRESS_FIFO(pf)			\
-	do {					\
-		destroy_address_fifo(pf);	\
-		(pf) = NULL;			\
-	} while (0)
-       void free_all_config_trees(void);	/* atexit() */
 static void free_config_tree(config_tree *ptree);
 
 static void destroy_restrict_node(restrict_node *my_node);
@@ -1138,25 +1131,6 @@ create_addr_opts_node(
  */
 
 static void
-destroy_address_fifo(
-	address_fifo *	pfifo
-	)
-{
-	address_node *	addr_node;
-
-	if (pfifo != NULL) {
-		for (;;) {
-			UNLINK_FIFO(addr_node, *pfifo, link);
-			if (addr_node == NULL)
-				break;
-			destroy_address_node(addr_node);
-		}
-		free(pfifo);
-	}
-}
-
-
-static void
 config_auth(
 	config_tree *ptree
 	)
diff --git a/ntpd/ntp_control.c b/ntpd/ntp_control.c
index 50faba1..c9a8884 100644
--- a/ntpd/ntp_control.c
+++ b/ntpd/ntp_control.c
@@ -697,7 +697,7 @@ ctl_error(
 	/*
 	 * send packet and bump counters
 	 */
-	if (res_authenticate && sys_authenticate) {
+	if (res_authenticate) {
 		maclen = authencrypt(res_keyid, (uint32_t *)&rpkt,
 				     CTL_HEADER_LEN);
 		sendpkt(rmt_addr, lcl_inter, -2, &rpkt,	CTL_HEADER_LEN + maclen);
@@ -803,8 +803,7 @@ process_control(
 	properlen = (properlen + 7) & ~7;
 	maclen = rbufp->recv_length - properlen;
 	if ((rbufp->recv_length & 3) == 0 &&
-	    maclen >= MIN_MAC_LEN && maclen <= MAX_MAC_LEN &&
-	    sys_authenticate) {
+	    maclen >= MIN_MAC_LEN && maclen <= MAX_MAC_LEN) {
 		res_authenticate = true;
 		pkid = (void *)((char *)pkt + properlen);
 		res_keyid = ntohl(*pkid);
@@ -970,7 +969,7 @@ ctl_flushpkt(
 			(res_opcode & CTL_OP_MASK);
 	rpkt.count = htons((u_short)dlen);
 	rpkt.offset = htons((u_short)res_offset);
-	if (res_authenticate && sys_authenticate) {
+	if (res_authenticate) {
 		totlen = sendlen;
 		/*
 		 * If we are going to authenticate, then there
diff --git a/ntpd/ntp_parser.y b/ntpd/ntp_parser.y
index 1ff4cd9..7783955 100644
--- a/ntpd/ntp_parser.y
+++ b/ntpd/ntp_parser.y
@@ -1082,8 +1082,7 @@ system_option
 	;
 
 system_option_flag_keyword
-	:	T_Auth
-	|	T_Calibrate
+	:	T_Calibrate
 	|	T_Kernel
 	|	T_Monitor
 	|	T_Ntp
diff --git a/ntpd/ntp_proto.c b/ntpd/ntp_proto.c
index 16c36ef..c6d328d 100644
--- a/ntpd/ntp_proto.c
+++ b/ntpd/ntp_proto.c
@@ -74,7 +74,6 @@ bool leap_sec_in_progress;
 /*
  * Nonspecified system state variables
  */
-bool	sys_authenticate;	/* require authentication for config */
 l_fp	sys_authdelay;		/* authentication delay */
 double	sys_offset;	/* current local clock offset */
 double	sys_mindisp = MINDISPERSE; /* minimum distance (s) */
@@ -803,7 +802,7 @@ receive(
 		handle_manycast(rbufp, restrict_mask, pkt, peer, authenticated);
 		break;
 	    default:
-		/* Everything else is for broadcast or multicast modes,
+		/* Everything else is for broadcast modes,
 		   which are a security nightmare.  So they go to the
 		   bit bucket until this improves.
 		*/
@@ -2795,7 +2794,6 @@ init_proto(const bool verbose)
 	get_systime(&dummy);
 	sys_survivors = 0;
 	sys_manycastserver = 0;
-	sys_authenticate = true;
 	sys_stattime = current_time;
 	orphwait = current_time + sys_orphwait;
 	proto_clr_stats();
@@ -2830,10 +2828,6 @@ proto_config(
 	/*
 	 * enable and disable commands - arguments are Boolean.
 	 */
-	case PROTO_AUTHENTICATE: /* authentication (auth) */
-		sys_authenticate = (bool)value;
-		break;
-
 #ifdef REFCLOCK
 	case PROTO_CAL:		/* refclock calibrate (calibrate) */
 		cal_enable = value;
@@ -2949,8 +2943,3 @@ proto_clr_stats(void)
 	sys_kodsent = 0;
 }
 
-void proto_dump(FILE *fp)
-{
-    /* must cover at least anything that can be set on the command line */
-    fprintf(fp, "%sable auth;\n", sys_authenticate ? "en" : "dis");
-}
diff --git a/ntpd/ntpd.c b/ntpd/ntpd.c
index f15e9e9..5476b36 100644
--- a/ntpd/ntpd.c
+++ b/ntpd/ntpd.c
@@ -792,7 +792,6 @@ ntpdmain(
 
      	/* use this to test if option setting gives expected results */
 	if (dumpopts) {
-	    proto_dump(stdout);
 	    if (explicit_config)
 		fprintf(stdout, "conffile \"%s\";\n", explicit_config);
 	    fprintf(stdout, "#debug = %d\n", debug);
-- 
2.7.4


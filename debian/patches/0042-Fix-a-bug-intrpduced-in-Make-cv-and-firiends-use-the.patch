From 6a30402a55fa56d578994c5a781971eee675ce57 Mon Sep 17 00:00:00 2001
From: "Eric S. Raymond" <esr@thyrsus.com>
Date: Sun, 27 Nov 2016 07:22:57 -0500
Subject: [PATCH 042/268] Fix a bug intrpduced in "Make cv and firiends use the
 terminal width."...

...and clean up some imports.
---
 ntpq/ntpq     |  2 +-
 pylib/util.py | 37 ++++++++++++++++++++-----------------
 2 files changed, 21 insertions(+), 18 deletions(-)

diff --git a/ntpq/ntpq b/ntpq/ntpq
index 9a3f130..27c92b8 100755
--- a/ntpq/ntpq
+++ b/ntpq/ntpq
@@ -443,7 +443,7 @@ usage: help [ command ]
                         lastcount = 0
                     else:
                         lastcount += 1
-                if lastcount + len(item) > self.termwidth - 2:
+                if lastcount + len(item) > ntp.util.termsize()[1] - 2:
                     text = text[:-1] + "\n"
                 text += item
             text = text[:-2] + "\n"
diff --git a/pylib/util.py b/pylib/util.py
index 104eb14..85ad43d 100644
--- a/pylib/util.py
+++ b/pylib/util.py
@@ -6,14 +6,16 @@ from __future__ import print_function
 import socket
 import sys
 import time
-import ntp.ntpc
 import re
 
-from ntp.packet import *
-from ntp.version import *
+import ntp.ntpc
+import ntp.version
+import ntp.ntp_magic
+import ntp.ntp_control
 
 def stdversion():
-    return "%s-%s-%s %s" % (VERSION, VCS_TICK, VCS_BASENAME, VCS_DATE)
+    return "%s-%s-%s %s" % (ntp.version.VERSION, ntp.version.VCS_TICK,
+                            ntp.version.VCS_BASENAME, ntp.version.VCS_DATE)
 
 def rfc3339(t):
     "RFC3339 string from Unix time, including fractional second."
@@ -181,11 +183,11 @@ class PeerSummary:
             elif name == "hpoll":
                 hpoll = value
                 if hpoll < 0:
-                    hpoll = NTP_MINPOLL
+                    hpoll = ntp.ntp_magic.NTP_MINPOLL
             elif name == "ppoll":
                 ppoll = value
                 if ppoll < 0:
-                    ppoll = NTP_MINPOLL
+                    ppoll = ntp.ntp_magic.NTP_MINPOLL
             elif name == "reach":
                 # Shipped as hex, displayed in octal
                 reach = value
@@ -205,16 +207,16 @@ class PeerSummary:
                 srcport = value
             elif name == "reftime":
                 reftime = value	# l_fp timestamp
-        if hmode == MODE_BCLIENT:
+        if hmode == ntp.ntp_magic.MODE_BCLIENT:
             # broadcastclient or multicastclient
             ptype = 'b'
-        elif hmode == MODE_BROADCAST:
+        elif hmode == ntp.ntp_magic.MODE_BROADCAST:
             # broadcast or multicast server
             if srcadr.startswith("224."):	# IANA multicast address prefix
                 ptype = 'M'
             else:
                 ptype = 'B'
-        elif hmode == MODE_CLIENT:
+        elif hmode == ntp.ntp_magic.MODE_CLIENT:
             if srchost and '(' in srchost:
                 ptype = 'l'	# local refclock
             elif dstadr_refid == "POOL":
@@ -223,9 +225,9 @@ class PeerSummary:
                 ptype = 'a'	# manycastclient
             else:
                 ptype = 'u'	# unicast
-        elif hmode == MODE_ACTIVE:
+        elif hmode == ntp.ntp_magic.MODE_ACTIVE:
             ptype = 's'		# symmetric active
-        elif hmode == MODE_PASSIVE:
+        elif hmode == ntp.ntp_magic.MODE_PASSIVE:
             ptype = 'S'		# symmetric passive
 
         #
@@ -233,10 +235,10 @@ class PeerSummary:
         #
         line = ""
         poll_sec = 1 << min(ppoll, hpoll)
-        if self.pktversion > NTP_OLDVERSION:
-            c = " x.-+#*o"[CTL_PEER_STATVAL(rstatus) & 0x7]
+        if self.pktversion > ntp.ntp_magic.NTP_OLDVERSION:
+            c = " x.-+#*o"[ntp.ntp_control.CTL_PEER_STATVAL(rstatus) & 0x7]
         else:
-            c = " .+*"[CTL_PEER_STATVAL(rstatus) & 0x3]
+            c = " .+*"[ntp.ntp_control.CTL_PEER_STATVAL(rstatus) & 0x3]
         # Source host or clockname
         if srchost != None:
             clock_name = srchost
@@ -309,9 +311,9 @@ class MRUSummary:
             stats += " %6d" % avgint
         else:
             stats += " %6.2f" % favgint
-        if entry.rs & RES_KOD:
+        if entry.rs & ntp.ntp_magic.RES_KOD:
             rscode = 'K'
-        elif entry.rs & RES_LIMITED:
+        elif entry.rs & ntp.ntp_magic.RES_LIMITED:
             rscode = 'L'
         else:
             rscode = '.'
@@ -321,7 +323,8 @@ class MRUSummary:
                 dns = canonicalize_dns(dns)
             stats += " %4hx %c %d %d %6d %5s %s" % \
                      (entry.rs, rscode,
-                      PKT_MODE(entry.mv), PKT_VERSION(entry.mv),
+                      ntp.ntp_magic.PKT_MODE(entry.mv),
+                      ntp.ntp_magic.PKT_VERSION(entry.mv),
                       entry.ct, port[1:], dns)
             return stats
         except TypeError:
-- 
2.7.4

